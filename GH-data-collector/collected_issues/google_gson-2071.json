{
  "issue_id": 2067,
  "issue_url": "https://github.com/google/gson/issues/2067",
  "title": "`EnumMap` deserialization fails with `ClassCastException`",
  "description": "<h1 dir=\"auto\">Gson version</h1>\n<p dir=\"auto\"><a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/google/gson/commit/e2e851c9bc692cec68ba7b0cbb002f82b4a229e4/hovercard\" href=\"https://github.com/google/gson/commit/e2e851c9bc692cec68ba7b0cbb002f82b4a229e4\"><tt>e2e851c</tt></a></p>\n<h1 dir=\"auto\">Java / Android version</h1>\n<p dir=\"auto\">openjdk version \"11.0.13\" 2021-10-19<br>\nOpenJDK Runtime Environment Temurin-11.0.13+8 (build 11.0.13+8)<br>\nOpenJDK 64-Bit Server VM Temurin-11.0.13+8 (build 11.0.13+8, mixed mode)</p>\n<h1 dir=\"auto\">Description</h1>\n<p dir=\"auto\"><code class=\"notranslate\">EnumMap</code> deserialization fails with <code class=\"notranslate\">ClassCastException</code>:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.ClassCastException: class java.util.LinkedHashMap cannot be cast to class java.util.EnumMap\"><pre class=\"notranslate\"><code>java.lang.ClassCastException: class java.util.LinkedHashMap cannot be cast to class java.util.EnumMap\n</code></pre></div>\n<p dir=\"auto\">The underlying issue is related to <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"624353159\" data-permission-text=\"Title is private\" data-url=\"https://github.com/google/gson/issues/1708\" data-hovercard-type=\"issue\" data-hovercard-url=\"/google/gson/issues/1708/hovercard\" href=\"https://github.com/google/gson/issues/1708\">#1708</a>, it appears special handling for <code class=\"notranslate\">EnumMap</code> is missing.<br>\n(I am a bit surprised that this issue has not been mentioned here anywhere before.)</p>\n<h1 dir=\"auto\">Reproduction steps</h1>\n<p dir=\"auto\">Test case:</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"private static enum MyEnum {\n  VALUE1, VALUE2\n}\n\npublic void testEnumMap() throws Exception {\n  EnumMap<MyEnum, String> map = new EnumMap<MyEnum, String>(MyEnum.class);\n  map.put(MyEnum.VALUE1, \"test\");\n  String json = gson.toJson(map);\n  assertEquals(\"{\\\"VALUE1\\\":\\\"test\\\"}\", json);\n\n  Type type = new TypeToken<EnumMap<MyEnum, String>>() {}.getType();\n  EnumMap<?, ?> actualMap = gson.fromJson(\"{\\\"VALUE1\\\":\\\"test\\\"}\", type);\n  Map<?, ?> expectedMap = Collections.singletonMap(MyEnum.VALUE1, \"test\");\n  assertEquals(expectedMap, actualMap);\n}\"><pre><span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">enum</span> <span class=\"pl-smi\">MyEnum</span> {\n  <span class=\"pl-c1\">VALUE1</span>, <span class=\"pl-c1\">VALUE2</span>\n}\n\n<span class=\"pl-k\">public</span> <span class=\"pl-smi\">void</span> <span class=\"pl-s1\">testEnumMap</span>() <span class=\"pl-k\">throws</span> <span class=\"pl-s1\">Exception</span> {\n  <span class=\"pl-smi\">EnumMap</span><<span class=\"pl-smi\">MyEnum</span>, <span class=\"pl-smi\">String</span>> <span class=\"pl-s1\">map</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">EnumMap</span><<span class=\"pl-smi\">MyEnum</span>, <span class=\"pl-smi\">String</span>>(<span class=\"pl-smi\">MyEnum</span>.<span class=\"pl-s1\">class</span>);\n  <span class=\"pl-s1\">map</span>.<span class=\"pl-en\">put</span>(<span class=\"pl-smi\">MyEnum</span>.<span class=\"pl-c1\">VALUE1</span>, <span class=\"pl-s\">\"test\"</span>);\n  <span class=\"pl-smi\">String</span> <span class=\"pl-s1\">json</span> = <span class=\"pl-s1\">gson</span>.<span class=\"pl-en\">toJson</span>(<span class=\"pl-s1\">map</span>);\n  <span class=\"pl-en\">assertEquals</span>(<span class=\"pl-s\">\"{\\\"VALUE1\\\":\\\"test\\\"}\"</span>, <span class=\"pl-s1\">json</span>);\n\n  <span class=\"pl-smi\">Type</span> <span class=\"pl-s1\">type</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">TypeToken</span><<span class=\"pl-smi\">EnumMap</span><<span class=\"pl-smi\">MyEnum</span>, <span class=\"pl-smi\">String</span>>>() {}.<span class=\"pl-en\">getType</span>();\n  <span class=\"pl-smi\">EnumMap</span><?, ?> <span class=\"pl-s1\">actualMap</span> = <span class=\"pl-s1\">gson</span>.<span class=\"pl-en\">fromJson</span>(<span class=\"pl-s\">\"{\\\"VALUE1\\\":\\\"test\\\"}\"</span>, <span class=\"pl-s1\">type</span>);\n  <span class=\"pl-smi\">Map</span><?, ?> <span class=\"pl-s1\">expectedMap</span> = <span class=\"pl-s1\">Collections</span>.<span class=\"pl-en\">singletonMap</span>(<span class=\"pl-smi\">MyEnum</span>.<span class=\"pl-c1\">VALUE1</span>, <span class=\"pl-s\">\"test\"</span>);\n  <span class=\"pl-en\">assertEquals</span>(<span class=\"pl-s1\">expectedMap</span>, <span class=\"pl-s1\">actualMap</span>);\n}</pre></div>\n<h1 dir=\"auto\">Exception stack trace</h1>\n<p dir=\"auto\">Not really useful because <code class=\"notranslate\">ClassCastException</code> occurs in user code.</p>",
  "description_text": "Gson version\ne2e851c\nJava / Android version\nopenjdk version \"11.0.13\" 2021-10-19\nOpenJDK Runtime Environment Temurin-11.0.13+8 (build 11.0.13+8)\nOpenJDK 64-Bit Server VM Temurin-11.0.13+8 (build 11.0.13+8, mixed mode)\nDescription\nEnumMap deserialization fails with ClassCastException:\njava.lang.ClassCastException: class java.util.LinkedHashMap cannot be cast to class java.util.EnumMap\n\nThe underlying issue is related to #1708, it appears special handling for EnumMap is missing.\n(I am a bit surprised that this issue has not been mentioned here anywhere before.)\nReproduction steps\nTest case:\n>() {}.getType();\n  EnumMap actualMap = gson.fromJson(\"{\\\"VALUE1\\\":\\\"test\\\"}\", type);\n  Map expectedMap = Collections.singletonMap(MyEnum.VALUE1, \"test\");\n  assertEquals(expectedMap, actualMap);\n}\">private static enum MyEnum {\n  VALUE1, VALUE2\n}\n\npublic void testEnumMap() throws Exception {\n  EnumMap<MyEnum, String> map = new EnumMap<MyEnum, String>(MyEnum.class);\n  map.put(MyEnum.VALUE1, \"test\");\n  String json = gson.toJson(map);\n  assertEquals(\"{\\\"VALUE1\\\":\\\"test\\\"}\", json);\n\n  Type type = new TypeToken<EnumMap<MyEnum, String>>() {}.getType();\n  EnumMap actualMap = gson.fromJson(\"{\\\"VALUE1\\\":\\\"test\\\"}\", type);\n  Map expectedMap = Collections.singletonMap(MyEnum.VALUE1, \"test\");\n  assertEquals(expectedMap, actualMap);\n}\nException stack trace\nNot really useful because ClassCastException occurs in user code."
}