{
  "issue_id": 2499,
  "issue_url": "https://github.com/mockito/mockito/issues/2499",
  "title": "Obscure issue with mockito-inline:  mock object in a test seems to be corrupting mock in later test",
  "description": "<p dir=\"auto\">This is a very obscure issue, happens only when the planets are aligned. Can you possibly tell me if this is an issue with mockito-inline or if I'm doing something wrong. If its an issue, is there a workaround?</p>\n<p dir=\"auto\">I've simplified what I'm seeing as much as possible. I have 2 tests: Test1 and Test2. I mock MyClass in Test1 (calling clearInlineMocks in <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/afterclass/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/afterclass\">@afterclass</a>).  In Test2, I mock TestSubInterface which extends TestInterface, which creates an instance of the class I mocked in Test1. The issue is that the constructor for MyClass is not being called when mocking the TestSubInterface in Test2  (I guess because mockito-inline still sees MyClass as a mock from the previous test?). I initialize a variable in the MyClass constructor and later throw an error if it hasn't been initialized, resulting in a java.lang.NoClassDefFoundError when mocking.</p>\n<p dir=\"auto\">HOWEVER, the constructor for MyClass IS called when:</p>\n<ul dir=\"auto\">\n<li>I mock TestInterface directly instead of TestSubInterface OR</li>\n<li>I do NOT have a default method defined in TestInterface OR</li>\n<li>I use mockito-core instead of mockito-inline</li>\n</ul>\n<p dir=\"auto\">Here are the details:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.NoClassDefFoundError: Could not initialize class TestSubInterface$MockitoMock$1328129486\n        at jdk.internal.reflect.GeneratedSerializationConstructorAccessor2.newInstance(Unknown Source)\n        at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)\n        at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:481)\n        at org.objenesis.instantiator.sun.SunReflectionFactoryInstantiator.newInstance(SunReflectionFactoryInstantiator.java:48)\n        at org.objenesis.ObjenesisBase.newInstance(ObjenesisBase.java:73)\n        at org.mockito.internal.creation.instance.ObjenesisInstantiator.newInstance(ObjenesisInstantiator.java:21)\n        at org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.doCreateMock(InlineByteBuddyMockMaker.java:360)\n        at org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMock(InlineByteBuddyMockMaker.java:318)\n        at org.mockito.internal.util.MockUtil.createMock(MockUtil.java:53)\n        at org.mockito.internal.MockitoCore.mock(MockitoCore.java:62)\n        at org.mockito.Mockito.mock(Mockito.java:1951)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.processAnnotationForMock(MockAnnotationProcessor.java:66)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.process(MockAnnotationProcessor.java:27)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.process(MockAnnotationProcessor.java:24)\n        at org.mockito.internal.configuration.IndependentAnnotationEngine.createMockFor(IndependentAnnotationEngine.java:46)\n        at org.mockito.internal.configuration.IndependentAnnotationEngine.process(IndependentAnnotationEngine.java:73)\n        at org.mockito.internal.configuration.InjectingAnnotationEngine.processIndependentAnnotations(InjectingAnnotationEngine.java:73)\n        at org.mockito.internal.configuration.InjectingAnnotationEngine.process(InjectingAnnotationEngine.java:47)\n        at org.mockito.MockitoAnnotations.openMocks(MockitoAnnotations.java:82)\n        at org.mockito.internal.runners.DefaultInternalRunner$1$1.evaluate(DefaultInternalRunner.java:49)\n        at org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)\n        at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)\n        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)\n        at org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)\n        at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)\n        at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\n        at org.junit.runners.ParentRunner.run(ParentRunner.java:413)\n        at org.mockito.internal.runners.DefaultInternalRunner$1.run(DefaultInternalRunner.java:99)\n        at org.mockito.internal.runners.DefaultInternalRunner.run(DefaultInternalRunner.java:105)\n        at org.mockito.internal.runners.StrictRunner.run(StrictRunner.java:40)\n        at org.mockito.junit.MockitoJUnitRunner.run(MockitoJUnitRunner.java:163)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:252)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:141)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:112)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:564)\n        at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)\n        at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)\n        at org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)\n        at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:115)\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:75)\"><pre class=\"notranslate\"><code>java.lang.NoClassDefFoundError: Could not initialize class TestSubInterface$MockitoMock$1328129486\n        at jdk.internal.reflect.GeneratedSerializationConstructorAccessor2.newInstance(Unknown Source)\n        at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)\n        at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:481)\n        at org.objenesis.instantiator.sun.SunReflectionFactoryInstantiator.newInstance(SunReflectionFactoryInstantiator.java:48)\n        at org.objenesis.ObjenesisBase.newInstance(ObjenesisBase.java:73)\n        at org.mockito.internal.creation.instance.ObjenesisInstantiator.newInstance(ObjenesisInstantiator.java:21)\n        at org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.doCreateMock(InlineByteBuddyMockMaker.java:360)\n        at org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMock(InlineByteBuddyMockMaker.java:318)\n        at org.mockito.internal.util.MockUtil.createMock(MockUtil.java:53)\n        at org.mockito.internal.MockitoCore.mock(MockitoCore.java:62)\n        at org.mockito.Mockito.mock(Mockito.java:1951)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.processAnnotationForMock(MockAnnotationProcessor.java:66)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.process(MockAnnotationProcessor.java:27)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.process(MockAnnotationProcessor.java:24)\n        at org.mockito.internal.configuration.IndependentAnnotationEngine.createMockFor(IndependentAnnotationEngine.java:46)\n        at org.mockito.internal.configuration.IndependentAnnotationEngine.process(IndependentAnnotationEngine.java:73)\n        at org.mockito.internal.configuration.InjectingAnnotationEngine.processIndependentAnnotations(InjectingAnnotationEngine.java:73)\n        at org.mockito.internal.configuration.InjectingAnnotationEngine.process(InjectingAnnotationEngine.java:47)\n        at org.mockito.MockitoAnnotations.openMocks(MockitoAnnotations.java:82)\n        at org.mockito.internal.runners.DefaultInternalRunner$1$1.evaluate(DefaultInternalRunner.java:49)\n        at org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)\n        at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)\n        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)\n        at org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)\n        at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)\n        at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\n        at org.junit.runners.ParentRunner.run(ParentRunner.java:413)\n        at org.mockito.internal.runners.DefaultInternalRunner$1.run(DefaultInternalRunner.java:99)\n        at org.mockito.internal.runners.DefaultInternalRunner.run(DefaultInternalRunner.java:105)\n        at org.mockito.internal.runners.StrictRunner.run(StrictRunner.java:40)\n        at org.mockito.junit.MockitoJUnitRunner.run(MockitoJUnitRunner.java:163)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:252)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:141)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:112)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:564)\n        at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)\n        at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)\n        at org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)\n        at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:115)\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:75)\n</code></pre></div>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"import org.junit.AfterClass;\nimport org.junit.Test;\nimport org.junit.runner.RunWith;\nimport org.mockito.Mock;\nimport org.mockito.Mockito;\nimport org.mockito.junit.MockitoJUnitRunner;\n\n@RunWith(MockitoJUnitRunner.Silent.class)\npublic class Test1 {\n\n    @Mock\n    private MyClass foo;\n\n    @AfterClass\n    public static void after() {\n        Mockito.framework().clearInlineMocks();\n    }\n\n    @Test\n    public void test() {\n        System.out.println(\"test1!\");\n    }\n}\"><pre><span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">junit</span>.<span class=\"pl-s1\">AfterClass</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">junit</span>.<span class=\"pl-s1\">Test</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">junit</span>.<span class=\"pl-s1\">runner</span>.<span class=\"pl-s1\">RunWith</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">mockito</span>.<span class=\"pl-s1\">Mock</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">mockito</span>.<span class=\"pl-s1\">Mockito</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">mockito</span>.<span class=\"pl-s1\">junit</span>.<span class=\"pl-s1\">MockitoJUnitRunner</span>;\n\n<span class=\"pl-c1\">@</span><span class=\"pl-c1\">RunWith</span>(<span class=\"pl-smi\">MockitoJUnitRunner</span>.<span class=\"pl-s1\">Silent</span>.<span class=\"pl-s1\">class</span>)\n<span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-smi\">Test1</span> {\n\n    <span class=\"pl-c1\">@</span><span class=\"pl-c1\">Mock</span>\n    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">MyClass</span> <span class=\"pl-s1\">foo</span>;\n\n    <span class=\"pl-c1\">@</span><span class=\"pl-c1\">AfterClass</span>\n    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">void</span> <span class=\"pl-en\">after</span>() {\n        <span class=\"pl-s1\">Mockito</span>.<span class=\"pl-en\">framework</span>().<span class=\"pl-en\">clearInlineMocks</span>();\n    }\n\n    <span class=\"pl-c1\">@</span><span class=\"pl-c1\">Test</span>\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">void</span> <span class=\"pl-en\">test</span>() {\n        <span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s\">\"test1!\"</span>);\n    }\n}</pre></div>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"import org.junit.Test;\nimport org.junit.runner.RunWith;\nimport org.mockito.Mock;\nimport org.mockito.junit.MockitoJUnitRunner;\n\n@RunWith(MockitoJUnitRunner.class)\npublic class Test2 {\n\n    @Mock\n    TestSubInterface testInterface;\n\n    @Test\n    public void test() {\n        System.out.println(\"test2!\");\n    }\n}\"><pre><span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">junit</span>.<span class=\"pl-s1\">Test</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">junit</span>.<span class=\"pl-s1\">runner</span>.<span class=\"pl-s1\">RunWith</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">mockito</span>.<span class=\"pl-s1\">Mock</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">org</span>.<span class=\"pl-s1\">mockito</span>.<span class=\"pl-s1\">junit</span>.<span class=\"pl-s1\">MockitoJUnitRunner</span>;\n\n<span class=\"pl-c1\">@</span><span class=\"pl-c1\">RunWith</span>(<span class=\"pl-smi\">MockitoJUnitRunner</span>.<span class=\"pl-s1\">class</span>)\n<span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-smi\">Test2</span> {\n\n    <span class=\"pl-c1\">@</span><span class=\"pl-c1\">Mock</span>\n    <span class=\"pl-smi\">TestSubInterface</span> <span class=\"pl-s1\">testInterface</span>;\n\n    <span class=\"pl-c1\">@</span><span class=\"pl-c1\">Test</span>\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">void</span> <span class=\"pl-en\">test</span>() {\n        <span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s\">\"test2!\"</span>);\n    }\n}</pre></div>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"public interface TestSubInterface extends TestInterface {\n}\"><pre><span class=\"pl-k\">public</span> <span class=\"pl-k\">interface</span> <span class=\"pl-smi\">TestSubInterface</span> <span class=\"pl-k\">extends</span> <span class=\"pl-smi\">TestInterface</span> {\n}</pre></div>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"public interface TestInterface {\n\n    MyClass foo = MyClass.createMyNumber(8, \"someType\").convertTo(\"someOtherType\");\n\n    default boolean someMethod() {\n        return true;\n    }\n}\"><pre><span class=\"pl-k\">public</span> <span class=\"pl-k\">interface</span> <span class=\"pl-smi\">TestInterface</span> {\n\n    <span class=\"pl-smi\">MyClass</span> <span class=\"pl-s1\">foo</span> = <span class=\"pl-s1\">MyClass</span>.<span class=\"pl-en\">createMyNumber</span>(<span class=\"pl-c1\">8</span>, <span class=\"pl-s\">\"someType\"</span>).<span class=\"pl-en\">convertTo</span>(<span class=\"pl-s\">\"someOtherType\"</span>);\n\n    <span class=\"pl-k\">default</span> <span class=\"pl-smi\">boolean</span> <span class=\"pl-en\">someMethod</span>() {\n        <span class=\"pl-k\">return</span> <span class=\"pl-c1\">true</span>;\n    }\n}</pre></div>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"public class MyClass {\n\n    private final double num;\n    private final String type;\n    private Object someInternalObj;\n\n    public static MyClass createMyNumber(double m, String  type) {\n        return new MyClass(m, type);\n    }\n\n    public MyClass(double num, String type) {\n        this.num = num;\n        this.type = type;\n        someInternalObj = new Object();\n        System.out.println(\"MyClass!!!!!!\");\n    }\n\n    public MyClass convertTo(String to) {\n        if(someInternalObj == null)\n            throw new RuntimeException(\"someInternalObj was null\");\n        return MyClass.createMyNumber(num, to);\n    }\n}\"><pre><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-smi\">MyClass</span> {\n\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">double</span> <span class=\"pl-s1\">num</span>;\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-s1\">type</span>;\n    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">Object</span> <span class=\"pl-s1\">someInternalObj</span>;\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">MyClass</span> <span class=\"pl-en\">createMyNumber</span>(<span class=\"pl-smi\">double</span> <span class=\"pl-s1\">m</span>, <span class=\"pl-smi\">String</span>  <span class=\"pl-s1\">type</span>) {\n        <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">MyClass</span>(<span class=\"pl-s1\">m</span>, <span class=\"pl-s1\">type</span>);\n    }\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">MyClass</span>(<span class=\"pl-smi\">double</span> <span class=\"pl-s1\">num</span>, <span class=\"pl-smi\">String</span> <span class=\"pl-s1\">type</span>) {\n        <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">num</span> = <span class=\"pl-s1\">num</span>;\n        <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">type</span> = <span class=\"pl-s1\">type</span>;\n        <span class=\"pl-s1\">someInternalObj</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">Object</span>();\n        <span class=\"pl-smi\">System</span>.<span class=\"pl-s1\">out</span>.<span class=\"pl-en\">println</span>(<span class=\"pl-s\">\"MyClass!!!!!!\"</span>);\n    }\n\n    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">MyClass</span> <span class=\"pl-en\">convertTo</span>(<span class=\"pl-smi\">String</span> <span class=\"pl-s1\">to</span>) {\n        <span class=\"pl-k\">if</span>(<span class=\"pl-s1\">someInternalObj</span> == <span class=\"pl-c1\">null</span>)\n            <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RuntimeException</span>(<span class=\"pl-s\">\"someInternalObj was null\"</span>);\n        <span class=\"pl-k\">return</span> <span class=\"pl-s1\">MyClass</span>.<span class=\"pl-en\">createMyNumber</span>(<span class=\"pl-s1\">num</span>, <span class=\"pl-s1\">to</span>);\n    }\n}</pre></div>\n<div class=\"highlight highlight-text-xml notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n\n    <groupId>org.example</groupId>\n    <artifactId>Test</artifactId>\n    <version>1.0-SNAPSHOT</version>\n\n    <properties>\n        <maven.compiler.source>15</maven.compiler.source>\n        <maven.compiler.target>15</maven.compiler.target>\n    </properties>\n\n    <dependencies>\n        <dependency>\n            <groupId>junit</groupId>\n            <artifactId>junit</artifactId>\n            <version>4.13.2</version>\n            <scope>test</scope>\n        </dependency>\n        <dependency>\n            <groupId>org.mockito</groupId>\n            <artifactId>mockito-inline</artifactId>\n            <version>3.9.0</version>\n            <scope>test</scope>\n        </dependency>\n\n    </dependencies>\n\n</project>\"><pre><?<span class=\"pl-ent\">xml</span><span class=\"pl-e\"> version</span>=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>1.0<span class=\"pl-pds\">\"</span></span><span class=\"pl-e\"> encoding</span>=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>UTF-8<span class=\"pl-pds\">\"</span></span>?>\n<<span class=\"pl-ent\">project</span> <span class=\"pl-e\">xmlns</span>=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>http://maven.apache.org/POM/4.0.0<span class=\"pl-pds\">\"</span></span>\n         <span class=\"pl-e\">xmlns</span><span class=\"pl-e\">:</span><span class=\"pl-e\">xsi</span>=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>http://www.w3.org/2001/XMLSchema-instance<span class=\"pl-pds\">\"</span></span>\n         <span class=\"pl-e\">xsi</span><span class=\"pl-e\">:</span><span class=\"pl-e\">schemaLocation</span>=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class=\"pl-pds\">\"</span></span>>\n    <<span class=\"pl-ent\">modelVersion</span>>4.0.0</<span class=\"pl-ent\">modelVersion</span>>\n\n    <<span class=\"pl-ent\">groupId</span>>org.example</<span class=\"pl-ent\">groupId</span>>\n    <<span class=\"pl-ent\">artifactId</span>>Test</<span class=\"pl-ent\">artifactId</span>>\n    <<span class=\"pl-ent\">version</span>>1.0-SNAPSHOT</<span class=\"pl-ent\">version</span>>\n\n    <<span class=\"pl-ent\">properties</span>>\n        <<span class=\"pl-ent\">maven</span>.compiler.source>15</<span class=\"pl-ent\">maven</span>.compiler.source>\n        <<span class=\"pl-ent\">maven</span>.compiler.target>15</<span class=\"pl-ent\">maven</span>.compiler.target>\n    </<span class=\"pl-ent\">properties</span>>\n\n    <<span class=\"pl-ent\">dependencies</span>>\n        <<span class=\"pl-ent\">dependency</span>>\n            <<span class=\"pl-ent\">groupId</span>>junit</<span class=\"pl-ent\">groupId</span>>\n            <<span class=\"pl-ent\">artifactId</span>>junit</<span class=\"pl-ent\">artifactId</span>>\n            <<span class=\"pl-ent\">version</span>>4.13.2</<span class=\"pl-ent\">version</span>>\n            <<span class=\"pl-ent\">scope</span>>test</<span class=\"pl-ent\">scope</span>>\n        </<span class=\"pl-ent\">dependency</span>>\n        <<span class=\"pl-ent\">dependency</span>>\n            <<span class=\"pl-ent\">groupId</span>>org.mockito</<span class=\"pl-ent\">groupId</span>>\n            <<span class=\"pl-ent\">artifactId</span>>mockito-inline</<span class=\"pl-ent\">artifactId</span>>\n            <<span class=\"pl-ent\">version</span>>3.9.0</<span class=\"pl-ent\">version</span>>\n            <<span class=\"pl-ent\">scope</span>>test</<span class=\"pl-ent\">scope</span>>\n        </<span class=\"pl-ent\">dependency</span>>\n\n    </<span class=\"pl-ent\">dependencies</span>>\n\n</<span class=\"pl-ent\">project</span>></pre></div>\n<p dir=\"auto\">I'm on windows 10</p>\n<p dir=\"auto\">java --version<br>\njava 17.0.1 2021-10-19 LTS<br>\nJava(TM) SE Runtime Environment (build 17.0.1+12-LTS-39)<br>\nJava HotSpot(TM) 64-Bit Server VM (build 17.0.1+12-LTS-39, mixed mode, sharing)</p>\n<p dir=\"auto\">check that</p>\n<ul dir=\"auto\">\n<li>[ x] The mockito message in the stacktrace have useful information, but it didn't help</li>\n<li>[ x] The problematic code (if that's possible) is copied here;<br>\nNote that some configuration are impossible to mock via Mockito</li>\n<li>[ x] Provide versions (mockito / jdk / os / any other relevant information)</li>\n<li>[x ] Provide a <a href=\"http://sscce.org\" rel=\"nofollow\">Short, Self Contained, Correct (Compilable), Example</a> of the issue<br>\n(same as any question on stackoverflow.com)</li>\n<li>[ x] Read the <a href=\"https://github.com/mockito/mockito/blob/main/.github/CONTRIBUTING.md\">contributing guide</a></li>\n</ul>",
  "description_text": "This is a very obscure issue, happens only when the planets are aligned. Can you possibly tell me if this is an issue with mockito-inline or if I'm doing something wrong. If its an issue, is there a workaround?\nI've simplified what I'm seeing as much as possible. I have 2 tests: Test1 and Test2. I mock MyClass in Test1 (calling clearInlineMocks in @afterclass).  In Test2, I mock TestSubInterface which extends TestInterface, which creates an instance of the class I mocked in Test1. The issue is that the constructor for MyClass is not being called when mocking the TestSubInterface in Test2  (I guess because mockito-inline still sees MyClass as a mock from the previous test?). I initialize a variable in the MyClass constructor and later throw an error if it hasn't been initialized, resulting in a java.lang.NoClassDefFoundError when mocking.\nHOWEVER, the constructor for MyClass IS called when:\n\nI mock TestInterface directly instead of TestSubInterface OR\nI do NOT have a default method defined in TestInterface OR\nI use mockito-core instead of mockito-inline\n\nHere are the details:\njava.lang.NoClassDefFoundError: Could not initialize class TestSubInterface$MockitoMock$1328129486\n        at jdk.internal.reflect.GeneratedSerializationConstructorAccessor2.newInstance(Unknown Source)\n        at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)\n        at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:481)\n        at org.objenesis.instantiator.sun.SunReflectionFactoryInstantiator.newInstance(SunReflectionFactoryInstantiator.java:48)\n        at org.objenesis.ObjenesisBase.newInstance(ObjenesisBase.java:73)\n        at org.mockito.internal.creation.instance.ObjenesisInstantiator.newInstance(ObjenesisInstantiator.java:21)\n        at org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.doCreateMock(InlineByteBuddyMockMaker.java:360)\n        at org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMock(InlineByteBuddyMockMaker.java:318)\n        at org.mockito.internal.util.MockUtil.createMock(MockUtil.java:53)\n        at org.mockito.internal.MockitoCore.mock(MockitoCore.java:62)\n        at org.mockito.Mockito.mock(Mockito.java:1951)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.processAnnotationForMock(MockAnnotationProcessor.java:66)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.process(MockAnnotationProcessor.java:27)\n        at org.mockito.internal.configuration.MockAnnotationProcessor.process(MockAnnotationProcessor.java:24)\n        at org.mockito.internal.configuration.IndependentAnnotationEngine.createMockFor(IndependentAnnotationEngine.java:46)\n        at org.mockito.internal.configuration.IndependentAnnotationEngine.process(IndependentAnnotationEngine.java:73)\n        at org.mockito.internal.configuration.InjectingAnnotationEngine.processIndependentAnnotations(InjectingAnnotationEngine.java:73)\n        at org.mockito.internal.configuration.InjectingAnnotationEngine.process(InjectingAnnotationEngine.java:47)\n        at org.mockito.MockitoAnnotations.openMocks(MockitoAnnotations.java:82)\n        at org.mockito.internal.runners.DefaultInternalRunner$1$1.evaluate(DefaultInternalRunner.java:49)\n        at org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)\n        at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)\n        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)\n        at org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)\n        at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)\n        at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\n        at org.junit.runners.ParentRunner.run(ParentRunner.java:413)\n        at org.mockito.internal.runners.DefaultInternalRunner$1.run(DefaultInternalRunner.java:99)\n        at org.mockito.internal.runners.DefaultInternalRunner.run(DefaultInternalRunner.java:105)\n        at org.mockito.internal.runners.StrictRunner.run(StrictRunner.java:40)\n        at org.mockito.junit.MockitoJUnitRunner.run(MockitoJUnitRunner.java:163)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:252)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:141)\n        at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:112)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:564)\n        at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)\n        at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)\n        at org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)\n        at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:115)\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:75)\n\nimport org.junit.AfterClass;\nimport org.junit.Test;\nimport org.junit.runner.RunWith;\nimport org.mockito.Mock;\nimport org.mockito.Mockito;\nimport org.mockito.junit.MockitoJUnitRunner;\n\n@RunWith(MockitoJUnitRunner.Silent.class)\npublic class Test1 {\n\n    @Mock\n    private MyClass foo;\n\n    @AfterClass\n    public static void after() {\n        Mockito.framework().clearInlineMocks();\n    }\n\n    @Test\n    public void test() {\n        System.out.println(\"test1!\");\n    }\n}\nimport org.junit.Test;\nimport org.junit.runner.RunWith;\nimport org.mockito.Mock;\nimport org.mockito.junit.MockitoJUnitRunner;\n\n@RunWith(MockitoJUnitRunner.class)\npublic class Test2 {\n\n    @Mock\n    TestSubInterface testInterface;\n\n    @Test\n    public void test() {\n        System.out.println(\"test2!\");\n    }\n}\npublic interface TestSubInterface extends TestInterface {\n}\npublic interface TestInterface {\n\n    MyClass foo = MyClass.createMyNumber(8, \"someType\").convertTo(\"someOtherType\");\n\n    default boolean someMethod() {\n        return true;\n    }\n}\npublic class MyClass {\n\n    private final double num;\n    private final String type;\n    private Object someInternalObj;\n\n    public static MyClass createMyNumber(double m, String  type) {\n        return new MyClass(m, type);\n    }\n\n    public MyClass(double num, String type) {\n        this.num = num;\n        this.type = type;\n        someInternalObj = new Object();\n        System.out.println(\"MyClass!!!!!!\");\n    }\n\n    public MyClass convertTo(String to) {\n        if(someInternalObj == null)\n            throw new RuntimeException(\"someInternalObj was null\");\n        return MyClass.createMyNumber(num, to);\n    }\n}\n\n\n4.0.0\norg.example\nTest\n1.0-SNAPSHOT\n\n15\n15\n\n\n\njunit\njunit\n4.13.2\ntest\n\n\norg.mockito\nmockito-inline\n3.9.0\ntest\n\n\n\">xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n    <modelVersion>4.0.0modelVersion>\n\n    <groupId>org.examplegroupId>\n    <artifactId>TestartifactId>\n    <version>1.0-SNAPSHOTversion>\n\n    <properties>\n        <maven.compiler.source>15maven.compiler.source>\n        <maven.compiler.target>15maven.compiler.target>\n    properties>\n\n    <dependencies>\n        <dependency>\n            <groupId>junitgroupId>\n            <artifactId>junitartifactId>\n            <version>4.13.2version>\n            <scope>testscope>\n        dependency>\n        <dependency>\n            <groupId>org.mockitogroupId>\n            <artifactId>mockito-inlineartifactId>\n            <version>3.9.0version>\n            <scope>testscope>\n        dependency>\n\n    dependencies>\n\nproject>\nI'm on windows 10\njava --version\njava 17.0.1 2021-10-19 LTS\nJava(TM) SE Runtime Environment (build 17.0.1+12-LTS-39)\nJava HotSpot(TM) 64-Bit Server VM (build 17.0.1+12-LTS-39, mixed mode, sharing)\ncheck that\n\n[ x] The mockito message in the stacktrace have useful information, but it didn't help\n[ x] The problematic code (if that's possible) is copied here;\nNote that some configuration are impossible to mock via Mockito\n[ x] Provide versions (mockito / jdk / os / any other relevant information)\n[x ] Provide a Short, Self Contained, Correct (Compilable), Example of the issue\n(same as any question on stackoverflow.com)\n[ x] Read the contributing guide\n"
}