{
  "issue_id": 2389,
  "issue_url": "https://github.com/mockito/mockito/issues/2389",
  "title": "Parallel use of mocks with deep stubbing may lead to ConcurrentModificationException",
  "description": "<p dir=\"auto\">Java8 / JUnit5<br>\nMockito version: 3.11.2</p>\n<p dir=\"auto\">Test class:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"import org.junit.jupiter.api.RepeatedTest;\nimport org.mockito.Answers;\n\nimport java.util.List;\nimport java.util.stream.IntStream;\n\nimport static org.mockito.Mockito.mock;\n\nclass ConcurrencyTest {\n\n    @RepeatedTest(value = 1000)\n    void test() {\n        final Service mock = mock(Service.class, Answers.RETURNS_DEEP_STUBS);\n        IntStream.range(1, 100).parallel().forEach(i -> mock.doSomething());\n    }\n\n    interface Service {\n        List<String> doSomething();\n    }\n}\n\"><pre class=\"notranslate\"><code>import org.junit.jupiter.api.RepeatedTest;\nimport org.mockito.Answers;\n\nimport java.util.List;\nimport java.util.stream.IntStream;\n\nimport static org.mockito.Mockito.mock;\n\nclass ConcurrencyTest {\n\n    @RepeatedTest(value = 1000)\n    void test() {\n        final Service mock = mock(Service.class, Answers.RETURNS_DEEP_STUBS);\n        IntStream.range(1, 100).parallel().forEach(i -> mock.doSomething());\n    }\n\n    interface Service {\n        List<String> doSomething();\n    }\n}\n\n</code></pre></div>\n<p dir=\"auto\">Error: 30/5000 iterations fail with <code class=\"notranslate\">java.util.ConcurrentModificationException</code></p>\n<p dir=\"auto\">Stacktrace:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Caused by: java.util.ConcurrentModificationException\n\tat java.util.LinkedList$ListItr.checkForComodification(LinkedList.java:966)\n\tat java.util.LinkedList$ListItr.next(LinkedList.java:888)\n\tat org.mockito.internal.stubbing.defaultanswers.ReturnsDeepStubs.deepStub(ReturnsDeepStubs.java:85)\n\tat org.mockito.internal.stubbing.defaultanswers.ReturnsDeepStubs.answer(ReturnsDeepStubs.java:75)\n\tat org.mockito.Answers.answer(Answers.java:99)\n\tat org.mockito.internal.handler.MockHandlerImpl.handle(MockHandlerImpl.java:110)\n\tat org.mockito.internal.handler.NullResultGuardian.handle(NullResultGuardian.java:29)\n\tat org.mockito.internal.handler.InvocationNotifierHandler.handle(InvocationNotifierHandler.java:34)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:82)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:56)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor$DispatcherDefaultingToRealMethod.interceptAbstract(MockMethodInterceptor.java:161)\n\tat ConcurrencyTest$Service$MockitoMock$351714249.doSomething(Unknown Source)\n\tat ConcurrencyTest.lambda$test$0(ConcurrencyTest.java:14)\n\tat java.util.stream.ForEachOps$ForEachOp$OfInt.accept(ForEachOps.java:204)\n\tat java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:110)\n\tat java.util.Spliterator$OfInt.forEachRemaining(Spliterator.java:693)\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)\n\tat java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)\n\tat java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)\n\tat java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)\n\tat java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)\n\tat java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)\n\tat java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:175)\"><pre class=\"notranslate\"><code>Caused by: java.util.ConcurrentModificationException\n\tat java.util.LinkedList$ListItr.checkForComodification(LinkedList.java:966)\n\tat java.util.LinkedList$ListItr.next(LinkedList.java:888)\n\tat org.mockito.internal.stubbing.defaultanswers.ReturnsDeepStubs.deepStub(ReturnsDeepStubs.java:85)\n\tat org.mockito.internal.stubbing.defaultanswers.ReturnsDeepStubs.answer(ReturnsDeepStubs.java:75)\n\tat org.mockito.Answers.answer(Answers.java:99)\n\tat org.mockito.internal.handler.MockHandlerImpl.handle(MockHandlerImpl.java:110)\n\tat org.mockito.internal.handler.NullResultGuardian.handle(NullResultGuardian.java:29)\n\tat org.mockito.internal.handler.InvocationNotifierHandler.handle(InvocationNotifierHandler.java:34)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:82)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:56)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor$DispatcherDefaultingToRealMethod.interceptAbstract(MockMethodInterceptor.java:161)\n\tat ConcurrencyTest$Service$MockitoMock$351714249.doSomething(Unknown Source)\n\tat ConcurrencyTest.lambda$test$0(ConcurrencyTest.java:14)\n\tat java.util.stream.ForEachOps$ForEachOp$OfInt.accept(ForEachOps.java:204)\n\tat java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:110)\n\tat java.util.Spliterator$OfInt.forEachRemaining(Spliterator.java:693)\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)\n\tat java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)\n\tat java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)\n\tat java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)\n\tat java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)\n\tat java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)\n\tat java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:175)\n</code></pre></div>\n<p dir=\"auto\">P.S. If the <code class=\"notranslate\">Answers.RETURNS_DEEP_STUBS</code> is removed, no error occurred.</p>",
  "description_text": "Java8 / JUnit5\nMockito version: 3.11.2\nTest class:\nimport org.junit.jupiter.api.RepeatedTest;\nimport org.mockito.Answers;\n\nimport java.util.List;\nimport java.util.stream.IntStream;\n\nimport static org.mockito.Mockito.mock;\n\nclass ConcurrencyTest {\n\n    @RepeatedTest(value = 1000)\n    void test() {\n        final Service mock = mock(Service.class, Answers.RETURNS_DEEP_STUBS);\n        IntStream.range(1, 100).parallel().forEach(i -> mock.doSomething());\n    }\n\n    interface Service {\n        List doSomething();\n    }\n}\n\n\nError: 30/5000 iterations fail with java.util.ConcurrentModificationException\nStacktrace:\nCaused by: java.util.ConcurrentModificationException\n\tat java.util.LinkedList$ListItr.checkForComodification(LinkedList.java:966)\n\tat java.util.LinkedList$ListItr.next(LinkedList.java:888)\n\tat org.mockito.internal.stubbing.defaultanswers.ReturnsDeepStubs.deepStub(ReturnsDeepStubs.java:85)\n\tat org.mockito.internal.stubbing.defaultanswers.ReturnsDeepStubs.answer(ReturnsDeepStubs.java:75)\n\tat org.mockito.Answers.answer(Answers.java:99)\n\tat org.mockito.internal.handler.MockHandlerImpl.handle(MockHandlerImpl.java:110)\n\tat org.mockito.internal.handler.NullResultGuardian.handle(NullResultGuardian.java:29)\n\tat org.mockito.internal.handler.InvocationNotifierHandler.handle(InvocationNotifierHandler.java:34)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:82)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:56)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor$DispatcherDefaultingToRealMethod.interceptAbstract(MockMethodInterceptor.java:161)\n\tat ConcurrencyTest$Service$MockitoMock$351714249.doSomething(Unknown Source)\n\tat ConcurrencyTest.lambda$test$0(ConcurrencyTest.java:14)\n\tat java.util.stream.ForEachOps$ForEachOp$OfInt.accept(ForEachOps.java:204)\n\tat java.util.stream.Streams$RangeIntSpliterator.forEachRemaining(Streams.java:110)\n\tat java.util.Spliterator$OfInt.forEachRemaining(Spliterator.java:693)\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)\n\tat java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:290)\n\tat java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:731)\n\tat java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)\n\tat java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)\n\tat java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)\n\tat java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:175)\n\nP.S. If the Answers.RETURNS_DEEP_STUBS is removed, no error occurred."
}